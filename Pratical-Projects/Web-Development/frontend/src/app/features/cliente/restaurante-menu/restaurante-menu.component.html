<div class="container py-4" *ngIf="menus.length; else semMenus">
  <h2 class="mb-4">📋 Menus do Restaurante</h2>
  <button class="btn btn-link mb-3" routerLink="/cliente/dashboard">
    🔙 Voltar
  </button>

  <div class="row">
    <!-- MENUS -->
    <div class="col-md-8">
      <div *ngFor="let menu of menus" class="card shadow-sm mb-4">
        <div
          class="card-header d-flex justify-content-between"
          style="cursor: pointer"
          (click)="menu.mostrar = !menu.mostrar"
        >
          <h5 class="mb-0">{{ menu.nome }}</h5>
          <span>{{ menu.mostrar ? "▲ Recolher" : "▼ Ver Pratos" }}</span>
        </div>
        <div class="card-body" *ngIf="menu.mostrar">
          <p class="text-muted">{{ menu.descricao }}</p>

          <div *ngFor="let cat of objectKeys(menu.categorias)">
            <h5 class="mt-3">{{ cat }}</h5>
            <div
              *ngFor="let sub of objectKeys(menu.categorias[cat])"
              class="ms-3"
            >
              <h6 class="text-muted">{{ sub }}</h6>
              <div
                *ngFor="let prato of menu.categorias[cat][sub]"
                class="border-bottom pb-3 mb-3"
              >
                <h6 style="cursor: pointer" (click)="abrirModal(prato)">
                  {{ prato.nome }}
                  <small class="text-primary">[ver detalhes]</small>
                </h6>
                <p class="text-muted">{{ prato.descricao }}</p>
                <div
                  *ngFor="let dose of prato.doses"
                  class="d-flex align-items-center mb-2"
                >
                  <span class="me-2"
                    >{{ dose.nome }} - €{{ dose.preco.toFixed(2) }}</span
                  >
                  <input
                    type="number"
                    min="1"
                    class="form-control w-auto me-2"
                    [(ngModel)]="quantidades[prato._id + '_' + dose.nome]"
                    placeholder="Qtd"
                  />
                  <button
                    class="btn btn-sm btn-primary"
                    (click)="adicionarAoCarrinho(prato, dose)"
                  >
                    ➕
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- CARRINHO -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h4>🛒 Carrinho</h4>
          <div *ngIf="tempoRestante > 0" class="mb-2 text-danger">
            ⏳ Tempo restante: {{ tempoRestante / 60 | number : "1.0-0" }}:{{
              tempoRestante % 60 < 10
                ? "0" + (tempoRestante % 60)
                : tempoRestante % 60
            }}
          </div>
          <div *ngIf="carrinho.length === 0" class="text-muted mb-2">
            Sem itens.
          </div>
          <ul class="list-group mb-3" *ngIf="carrinho.length">
            <li
              *ngFor="let item of carrinho; let i = index"
              class="list-group-item d-flex justify-content-between"
            >
              <div>
                <strong>{{ item.prato.nome }}</strong
                ><br />{{ item.dose }}×{{ item.quantidade }}
              </div>
              <div>
                €{{ (item.precoUnitario * item.quantidade).toFixed(2) }}
                <button
                  class="btn btn-sm btn-danger ms-2"
                  (click)="removerDoCarrinho(i)"
                >
                  🗑️
                </button>
              </div>
            </li>
          </ul>
          <p class="fw-bold">Total: €{{ totalCarrinho().toFixed(2) }}</p>

          <!-- Método de Pagamento -->
          <div class="mb-3">
            <label class="form-label">Método de Pagamento:</label>
            <select class="form-select" [(ngModel)]="metodoPagamento" required>
              <option value="" disabled selected>Escolhe um método</option>
              <option *ngFor="let m of metodosPagamentoDisponiveis" [value]="m">
                {{ m }}
              </option>
            </select>
          </div>

          <!-- Morada -->
          <div class="mb-3">
            <label class="form-label">📍 Morada de Entrega:</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="moradaEntrega"
              placeholder="Rua, nº, cidade..."
              required
            />
          </div>

          <!-- Cartão de Crédito -->
          <div
            *ngIf="metodoPagamento === 'Cartão de Crédito/Débito'"
            class="alert alert-info"
          >
            Serás redirecionado para o pagamento seguro via Stripe.
          </div>

          <!-- MB Way -->
          <div *ngIf="metodoPagamento === 'MB Way'" class="mb-3">
            <label class="form-label">📱 Telemóvel MB Way:</label>
            <input
              type="tel"
              class="form-control"
              [(ngModel)]="dadosMbway.telefone"
              placeholder="9XXXXXXXX"
            />
          </div>

          <!-- Referência Multibanco -->
          <div *ngIf="metodoPagamento === 'Referência Multibanco'" class="mb-3">
            <label class="form-label">🏦 Dados da Referência:</label>
            <input
              type="text"
              class="form-control mb-2"
              [(ngModel)]="dadosReferencia.entidade"
              placeholder="Entidade"
            />
            <input
              type="text"
              class="form-control mb-2"
              [(ngModel)]="dadosReferencia.referencia"
              placeholder="Referência"
            />
            <input
              type="number"
              class="form-control"
              [(ngModel)]="dadosReferencia.valor"
              placeholder="Valor (€)"
            />
          </div>

          <button
            class="btn btn-success w-100"
            (click)="finalizarEncomenda()"
            [disabled]="
              !metodoPagamento || carrinho.length === 0 || !moradaEntrega
            "
          >
            ✅ Finalizar Encomenda
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DETALHES DO PRATO -->
  <div class="modal-backdrop fade show" *ngIf="modalAberto"></div>
  <div
    class="modal fade show d-block"
    tabindex="-1"
    *ngIf="modalAberto"
    style="z-index: 1055"
  >
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content shadow">
        <div class="modal-header">
          <h5 class="modal-title">{{ pratoSelecionado?.nome }}</h5>
          <button class="btn-close" (click)="fecharModal()"></button>
        </div>
        <div class="modal-body">
          <img
            *ngIf="pratoSelecionado?.imagem"
            [src]="getImagemSrc(pratoSelecionado.imagem)"
            class="img-fluid rounded mb-3"
            alt="Imagem"
          />
          <p class="text-muted">{{ pratoSelecionado?.descricao }}</p>
          <h6 class="fw-bold">🍽️ Doses:</h6>
          <ul class="list-group mb-3">
            <li
              *ngFor="let d of pratoSelecionado?.doses"
              class="list-group-item"
            >
              {{ d.nome }} — €{{ d.preco.toFixed(2) }}
            </li>
          </ul>
          <h6 class="fw-bold">🧪 Nutrição:</h6>
          <ul class="list-group mb-3">
            <li class="list-group-item">
              Calorias: {{ pratoSelecionado?.infoNutricional.calorias }}
            </li>
            <li class="list-group-item">
              Proteínas: {{ pratoSelecionado?.infoNutricional.proteinas }}g
            </li>
            <li class="list-group-item">
              Hidratos: {{ pratoSelecionado?.infoNutricional.hidratos }}g
            </li>
            <li class="list-group-item">
              Gorduras: {{ pratoSelecionado?.infoNutricional.gorduras }}g
            </li>
          </ul>
          <h6 class="fw-bold">⚠️ Alergénios:</h6>
          <span
            *ngFor="let a of pratoSelecionado?.alergenios"
            class="badge bg-warning text-dark me-1"
            >{{ a }}</span
          >
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="fecharModal()">
            Fechar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #semMenus>
  <div class="container py-4 text-center">
    <h3 class="text-muted mt-5">
      Este restaurante não tem menus disponíveis no momento.
    </h3>
    <button class="btn btn-link mt-3" routerLink="/cliente/dashboard">
      🔙 Voltar
    </button>
  </div>
</ng-template>
