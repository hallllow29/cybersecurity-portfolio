<%
let lat = 38.7169; // Lisboa fallback
let lng = -9.1399;

if (restaurante.localizacao && Array.isArray(restaurante.localizacao.coordinates) && restaurante.localizacao.coordinates.length === 2) {
  lat = restaurante.localizacao.coordinates[0];
  lng = restaurante.localizacao.coordinates[1];
}
%>
<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Perfil do Restaurante</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    #map {
      height: 300px;
      width: 100%;
      border-radius: 10px;
      margin-top: 10px;
    }

    .leaflet-popup-content-wrapper,
    .leaflet-popup-tip {
      transform: none !important;
    }

    .perfil-card {
      max-width: 900px;
      margin: auto;
    }

    .perfil-info p {
      margin-bottom: 0.5rem;
    }

    .perfil-info i {
      width: 24px;
      text-align: center;
    }

    .bg-capa {
      width: 100%;
      height: 250px;
      background-size: cover;
      background-position: center;
      border-radius: 10px 10px 0 0;
    }

    .logo-img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 50%;
      border: 4px solid white;
      margin-top: -60px;
      background: white;
    }
  </style>
</head>

<body>
  <div class="container mt-4">
    <div class="card shadow perfil-card">
      <div class="bg-capa" style="background-image: url('<%= restaurante.capaUrl || '/images/default-cover.jpg' %>');"></div>

      <div class="text-center">
        <img src="<%= restaurante.logoUrl %>" class="logo-img" alt="Logo" />
        <h2 class="mt-2"><%= restaurante.nome %></h2>
        <p class="text-muted"><%= restaurante.tipoCozinha %></p>
      </div>

      <div class="card-body perfil-info">
        <h5 class="mb-3">
          <i class="fas fa-info-circle"></i> Informações Gerais
        </h5>
        <p><i class="fas fa-user"></i> <strong>Responsável:</strong> <%= restaurante.pessoaResponsavel %></p>
        <p><i class="fas fa-envelope"></i> <strong>Email:</strong> <%= email || 'Não disponível' %></p>
        <p><i class="fas fa-phone"></i> <strong>Telefone:</strong> <%= restaurante.telefone %></p>
        <p><i class="fas fa-id-card"></i> <strong>NIF:</strong> <%= restaurante.nif %></p>
        <p><i class="fas fa-map-marker-alt"></i> <strong>Morada:</strong> <%= restaurante.morada %></p>
        <p><i class="fas fa-credit-card"></i> <strong>Métodos de Pagamento:</strong> <%= restaurante.metodosDePagamento?.length ? restaurante.metodosDePagamento.join(", ") : "Não definidos" %></p>

        <h5 class="mt-4 mb-3"><i class="fas fa-clock"></i> Funcionamento</h5>
        <% if (restaurante.horarioFuncionamento && restaurante.horarioFuncionamento.length) { %>
          <% restaurante.horarioFuncionamento.forEach(function(horario) { %>
            <p>
              <strong><%= horario.dia %>:</strong>
              <% if (horario.fechado) { %> Fechado <% } else { %> Abre às <%= horario.abre %> - Fecha às <%= horario.fecha %> <% } %>
            </p>
          <% }); %>
        <% } else { %>
          <p>Horário não definido</p>
        <% } %>

        <h5 class="mt-4 mb-3"><i class="fas fa-truck"></i> Entregas</h5>
        <p><strong>Tempo de Confecção:</strong> <%= restaurante.tempoConfecao %> min</p>
        <p><strong>Tempo de Entrega:</strong> <%= restaurante.tempoEntrega %> min</p>
        <p><strong>Raio de Entrega:</strong> <%= restaurante.raioEntregaKm %> km</p>
        <p><strong>Máx. Encomendas/Hora:</strong> <%= restaurante.maxEncomendasPorHora %></p>

        <h5 class="mt-4 mb-3"><i class="fas fa-globe"></i> Localização</h5>
        <div id="map"></div>

        <h5 class="mt-4 mb-3"><i class="fas fa-shield-alt"></i> Estado</h5>
        <p><strong>Validado:</strong> <%= restaurante.validado ? "Sim" : "Não" %></p>
        <p><strong>Ativo:</strong> <%= restaurante.ativo ? "Sim" : "Não" %></p>
      </div>

      <div class="text-center mb-4">
        <a href="/restaurante/editar" class="btn btn-warning me-2">
          <i class="fas fa-edit"></i> Editar Perfil
        </a>
        <a href="/restaurante/dashboard" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i> Voltar
        </a>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const lat = <%= lat %>;
      const lng = <%= lng %>;

      const map = L.map('map').setView([lat, lng], 15);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
      }).addTo(map);

      L.marker([lat, lng])
        .addTo(map)
        .bindPopup('<b><%= restaurante.nome %></b><br><%= restaurante.morada %>')
        .openPopup();
    });
  </script>
</body>
</html>
